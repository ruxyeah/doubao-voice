<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #333;
            margin-bottom: 16px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 500;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 16px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-disconnected { background: #ffeaea; color: #e74c3c; }
        .status-disconnected .status-dot { background: #e74c3c; }
        .status-connected { background: #e8f5e9; color: #27ae60; }
        .status-connected .status-dot { background: #27ae60; }
        .status-session { background: #e3f2fd; color: #2196f3; }
        .status-session .status-dot { background: #2196f3; animation: none; }

        .log-container {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 16px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }
        .log-entry {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .log-time {
            color: #888;
            margin-right: 8px;
        }
        .log-info { color: #64b5f6; }
        .log-success { color: #81c784; }
        .log-error { color: #e57373; }
        .log-asr { color: #fff176; }
        .log-chat { color: #ce93d8; }
        .log-tts { color: #4dd0e1; }

        .chat-container {
            height: 200px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #fafafa;
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 80%;
        }
        .chat-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .chat-bot {
            background: #e8e8e8;
            color: #333;
        }
        .chat-interim {
            opacity: 0.6;
            font-style: italic;
        }

        .text-input-group {
            display: flex;
            gap: 10px;
        }
        .text-input-group input {
            flex: 1;
        }

        .recording {
            animation: recording-pulse 1s infinite;
        }
        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯æµ‹è¯•</h1>

        <!-- é…ç½®å¡ç‰‡ -->
        <div class="card">
            <h2>ä¼šè¯é…ç½®</h2>
            <div class="form-group">
                <label>éŸ³è‰²</label>
                <select id="speaker">
                    <option value="zh_female_vv_jupiter_bigtts">å¥³å£°-ç”œç¾ï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="zh_male_rap_luna_bigtts">ç”·å£°-è¯´å”±</option>
                    <option value="zh_female_shuangkuaisisi_moon_bigtts">å¥³å£°-çˆ½å¿«æ€æ€</option>
                </select>
            </div>
            <div class="form-group">
                <label>æœºå™¨äººåç§°</label>
                <input type="text" id="botName" value="è±†åŒ…" placeholder="AIåŠ©æ‰‹åç§°">
            </div>
            <div class="form-group">
                <label>ç³»ç»Ÿè§’è‰²è®¾å®š</label>
                <textarea id="systemRole" rows="2" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ï¼Œå–„äºå›ç­”å„ç§é—®é¢˜"></textarea>
            </div>
            <div class="form-group">
                <label>æ¨¡å‹ç‰ˆæœ¬</label>
                <select id="model">
                    <option value="O">O - åŸºç¡€ç‰ˆæœ¬</option>
                    <option value="SC">SC - å£°éŸ³å¤åˆ»ç‰ˆæœ¬</option>
                    <option value="1.2.1.0">1.2.1.0 - O2.0ç‰ˆæœ¬</option>
                    <option value="2.2.0.0">2.2.0.0 - SC2.0ç‰ˆæœ¬</option>
                </select>
            </div>
        </div>

        <!-- æ§åˆ¶å¡ç‰‡ -->
        <div class="card">
            <h2>è¿æ¥æ§åˆ¶</h2>
            <div id="statusBadge" class="status status-disconnected">
                <span class="status-dot"></span>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
            <div>
                <button id="btnConnect" class="btn btn-primary" onclick="connect()">è¿æ¥</button>
                <button id="btnStartSession" class="btn btn-success" onclick="startSession()" disabled>å¼€å§‹ä¼šè¯</button>
                <button id="btnEndSession" class="btn btn-danger" onclick="endSession()" disabled>ç»“æŸä¼šè¯</button>
                <button id="btnDisconnect" class="btn btn-danger" onclick="disconnect()" disabled>æ–­å¼€è¿æ¥</button>
            </div>
        </div>

        <!-- å¯¹è¯å¡ç‰‡ -->
        <div class="card">
            <h2>å¯¹è¯</h2>
            <div id="chatContainer" class="chat-container"></div>

            <div class="text-input-group">
                <input type="text" id="textInput" placeholder="è¾“å…¥æ–‡æœ¬æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')sendText()">
                <button class="btn btn-primary" onclick="sendText()" id="btnSendText" disabled>å‘é€æ–‡æœ¬</button>
            </div>

            <div style="margin-top: 16px;">
                <button id="btnMic" class="btn btn-success" onclick="toggleMic()" disabled>
                    ğŸ¤ å¼€å§‹å½•éŸ³
                </button>
                <span id="micStatus" style="margin-left: 10px; color: #666;"></span>
            </div>
        </div>

        <!-- æ—¥å¿—å¡ç‰‡ -->
        <div class="card">
            <h2>æ—¥å¿—</h2>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let ws = null;
        let sessionId = null;
        let audioContext = null;
        let mediaStream = null;
        let processor = null;
        let isRecording = false;
        let audioQueue = [];
        let isPlaying = false;

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            const badge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            badge.className = `status status-${status}`;
            statusText.textContent = text;
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(text, isUser, isInterim = false) {
            const container = document.getElementById('chatContainer');

            // å¦‚æœæ˜¯ä¸´æ—¶æ¶ˆæ¯ï¼Œå…ˆç§»é™¤ä¹‹å‰çš„ä¸´æ—¶æ¶ˆæ¯
            if (isInterim) {
                const oldInterim = container.querySelector('.chat-interim');
                if (oldInterim) oldInterim.remove();
            }

            const msg = document.createElement('div');
            msg.className = `chat-message ${isUser ? 'chat-user' : 'chat-bot'} ${isInterim ? 'chat-interim' : ''}`;
            msg.textContent = text;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;

            // å¦‚æœæ˜¯æœ€ç»ˆæ¶ˆæ¯ï¼Œç§»é™¤ä¸´æ—¶æ¶ˆæ¯
            if (!isInterim && !isUser) {
                const oldInterim = container.querySelector('.chat-interim');
                if (oldInterim) oldInterim.remove();
            }
        }

        // è¿æ¥WebSocket
        function connect() {
            log('æ­£åœ¨è¿æ¥æœåŠ¡å™¨...', 'info');

            // å…ˆé€šè¿‡REST APIåˆ›å»ºä¼šè¯
            fetch('/api/v1/voice/sessions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(res => res.json())
            .then(data => {
                sessionId = data.sessionId;
                log(`ä¼šè¯å·²åˆ›å»º: ${sessionId}`, 'success');

                // è¿æ¥WebSocket
                const wsUrl = `ws://${window.location.host}/ws/voice?sessionId=${sessionId}`;
                ws = new WebSocket(wsUrl);
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    log('WebSocketå·²è¿æ¥', 'success');
                    updateStatus('connected', 'å·²è¿æ¥');
                    document.getElementById('btnConnect').disabled = true;
                    document.getElementById('btnStartSession').disabled = false;
                    document.getElementById('btnDisconnect').disabled = false;
                };

                ws.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        // äºŒè¿›åˆ¶éŸ³é¢‘æ•°æ®
                        handleAudioData(event.data);
                    } else {
                        // JSONæ¶ˆæ¯
                        const msg = JSON.parse(event.data);
                        handleMessage(msg);
                    }
                };

                ws.onclose = () => {
                    log('WebSocketå·²æ–­å¼€', 'error');
                    updateStatus('disconnected', 'å·²æ–­å¼€');
                    resetUI();
                };

                ws.onerror = (err) => {
                    log('WebSocketé”™è¯¯: ' + err, 'error');
                };
            })
            .catch(err => {
                log('åˆ›å»ºä¼šè¯å¤±è´¥: ' + err, 'error');
            });
        }

        // å¤„ç†æ¶ˆæ¯
        function handleMessage(msg) {
            switch (msg.type) {
                case 'status':
                    log(`çŠ¶æ€: ${msg.status}`, 'success');
                    if (msg.status === 'session_started') {
                        updateStatus('session', 'ä¼šè¯ä¸­');
                        document.getElementById('btnStartSession').disabled = true;
                        document.getElementById('btnEndSession').disabled = false;
                        document.getElementById('btnMic').disabled = false;
                        document.getElementById('btnSendText').disabled = false;
                    } else if (msg.status === 'session_finished') {
                        updateStatus('connected', 'å·²è¿æ¥');
                        document.getElementById('btnStartSession').disabled = false;
                        document.getElementById('btnEndSession').disabled = true;
                        document.getElementById('btnMic').disabled = true;
                        document.getElementById('btnSendText').disabled = true;
                        stopRecording();
                    }
                    break;

                case 'asr':
                    if (msg.event === 'result') {
                        log(`ASR: ${msg.text} ${msg.isInterim ? '(ä¸´æ—¶)' : '(æœ€ç»ˆ)'}`, 'asr');
                        if (!msg.isInterim) {
                            addChatMessage(msg.text, true);
                        }
                    } else if (msg.event === 'speech_started') {
                        log('æ£€æµ‹åˆ°ç”¨æˆ·è¯´è¯', 'asr');
                        // æ¸…ç©ºéŸ³é¢‘é˜Ÿåˆ—ï¼Œåœæ­¢æ’­æ”¾
                        audioQueue = [];
                    }
                    break;

                case 'chat':
                    if (msg.event === 'response') {
                        log(`AI: ${msg.text}`, 'chat');
                        addChatMessage(msg.text, false);
                    }
                    break;

                case 'tts':
                    if (msg.event === 'sentence_start') {
                        log(`TTSå¼€å§‹: ${msg.text}`, 'tts');
                    } else if (msg.event === 'ended') {
                        log('TTSæ’­æ”¾ç»“æŸ', 'tts');
                    }
                    break;

                case 'error':
                    log(`é”™è¯¯: ${msg.error}`, 'error');
                    break;
            }
        }

        // å¤„ç†éŸ³é¢‘æ•°æ®
        function handleAudioData(data) {
            audioQueue.push(data);
            if (!isPlaying) {
                playNextAudio();
            }
        }

        // æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—
        async function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            isPlaying = true;
            const data = audioQueue.shift();

            try {
                if (!audioContext) {
                    audioContext = new AudioContext({ sampleRate: 24000 });
                }

                // æ•°æ®æ˜¯Float32æ ¼å¼
                const float32Array = new Float32Array(data);
                const audioBuffer = audioContext.createBuffer(1, float32Array.length, 24000);
                audioBuffer.getChannelData(0).set(float32Array);

                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.onended = () => playNextAudio();
                source.start();
            } catch (e) {
                log('æ’­æ”¾éŸ³é¢‘å¤±è´¥: ' + e.message, 'error');
                playNextAudio();
            }
        }

        // å¼€å§‹ä¼šè¯
        function startSession() {
            const config = {
                speaker: document.getElementById('speaker').value,
                botName: document.getElementById('botName').value,
                systemRole: document.getElementById('systemRole').value,
                model: document.getElementById('model').value
            };

            log('æ­£åœ¨å¯åŠ¨ä¼šè¯...', 'info');
            ws.send(JSON.stringify({
                type: 'control',
                action: 'start',
                config: config
            }));
        }

        // ç»“æŸä¼šè¯
        function endSession() {
            log('æ­£åœ¨ç»“æŸä¼šè¯...', 'info');
            ws.send(JSON.stringify({
                type: 'control',
                action: 'end'
            }));
            stopRecording();
        }

        // æ–­å¼€è¿æ¥
        function disconnect() {
            stopRecording();
            if (ws) {
                ws.close();
                ws = null;
            }
            resetUI();
        }

        // é‡ç½®UI
        function resetUI() {
            document.getElementById('btnConnect').disabled = false;
            document.getElementById('btnStartSession').disabled = true;
            document.getElementById('btnEndSession').disabled = true;
            document.getElementById('btnDisconnect').disabled = true;
            document.getElementById('btnMic').disabled = true;
            document.getElementById('btnSendText').disabled = true;
            updateStatus('disconnected', 'æœªè¿æ¥');
        }

        // å‘é€æ–‡æœ¬
        function sendText() {
            const input = document.getElementById('textInput');
            const text = input.value.trim();
            if (!text) return;

            log(`å‘é€æ–‡æœ¬: ${text}`, 'info');
            addChatMessage(text, true);

            ws.send(JSON.stringify({
                type: 'text',
                text: text
            }));

            input.value = '';
        }

        // åˆ‡æ¢éº¦å…‹é£
        function toggleMic() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                // å…¼å®¹æ€§æ£€æŸ¥
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    // å°è¯•ä½¿ç”¨æ—§ç‰ˆAPI
                    navigator.mediaDevices = navigator.mediaDevices || {};
                    navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia ||
                        navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia ||
                        navigator.msGetUserMedia;

                    if (!navigator.mediaDevices.getUserMedia) {
                        throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£è®¿é—®ã€‚è¯·ä½¿ç”¨ Chromeã€Firefox æˆ– Edge æµè§ˆå™¨ï¼Œå¹¶ç¡®ä¿é€šè¿‡ HTTPS æˆ– localhost è®¿é—®ã€‚');
                    }
                }

                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 48000,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                const context = new AudioContext({ sampleRate: 48000 });
                const source = context.createMediaStreamSource(mediaStream);
                processor = context.createScriptProcessor(4096, 1, 1);

                processor.onaudioprocess = (e) => {
                    if (!isRecording) return;

                    const inputData = e.inputBuffer.getChannelData(0);
                    // é‡é‡‡æ · 48kHz -> 16kHz
                    const resampledData = resample(inputData, 48000, 16000);
                    // è½¬æ¢ä¸ºPCM16
                    const pcmData = convertToPCM16(resampledData);

                    // å‘é€éŸ³é¢‘æ•°æ®
                    ws.send(JSON.stringify({
                        type: 'audio',
                        data: arrayBufferToBase64(pcmData.buffer)
                    }));
                };

                source.connect(processor);
                processor.connect(context.destination);

                isRecording = true;
                document.getElementById('btnMic').textContent = 'ğŸ”´ åœæ­¢å½•éŸ³';
                document.getElementById('btnMic').classList.add('recording');
                document.getElementById('micStatus').textContent = 'æ­£åœ¨å½•éŸ³...';
                log('å¼€å§‹å½•éŸ³', 'success');

            } catch (e) {
                log('æ— æ³•è®¿é—®éº¦å…‹é£: ' + e.message, 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            isRecording = false;
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            document.getElementById('btnMic').textContent = 'ğŸ¤ å¼€å§‹å½•éŸ³';
            document.getElementById('btnMic').classList.remove('recording');
            document.getElementById('micStatus').textContent = '';
            log('åœæ­¢å½•éŸ³', 'info');
        }

        // é‡é‡‡æ ·
        function resample(inputData, fromRate, toRate) {
            const ratio = fromRate / toRate;
            const newLength = Math.round(inputData.length / ratio);
            const result = new Float32Array(newLength);

            for (let i = 0; i < newLength; i++) {
                const srcIndex = i * ratio;
                const srcIndexFloor = Math.floor(srcIndex);
                const srcIndexCeil = Math.min(srcIndexFloor + 1, inputData.length - 1);
                const t = srcIndex - srcIndexFloor;
                result[i] = inputData[srcIndexFloor] * (1 - t) + inputData[srcIndexCeil] * t;
            }
            return result;
        }

        // è½¬æ¢ä¸ºPCM16
        function convertToPCM16(float32Array) {
            const int16Array = new Int16Array(float32Array.length);
            for (let i = 0; i < float32Array.length; i++) {
                const sample = Math.max(-1, Math.min(1, float32Array[i]));
                int16Array[i] = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
            }
            return new Uint8Array(int16Array.buffer);
        }

        // ArrayBufferè½¬Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // é¡µé¢åˆå§‹åŒ– - æ£€æŸ¥å®‰å…¨ä¸Šä¸‹æ–‡
        (function init() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨ä¸Šä¸‹æ–‡
            const isSecureContext = window.isSecureContext ||
                location.protocol === 'https:' ||
                location.hostname === 'localhost' ||
                location.hostname === '127.0.0.1';

            if (!isSecureContext) {
                log('è­¦å‘Š: å½“å‰é¡µé¢ä¸åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼Œéº¦å…‹é£åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚è¯·é€šè¿‡ https:// æˆ– localhost è®¿é—®ã€‚', 'error');
            }

            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!navigator.mediaDevices && !navigator.getUserMedia) {
                log('è­¦å‘Š: æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒéº¦å…‹é£è®¿é—®ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Firefox æˆ– Edgeã€‚', 'error');
            }

            log('é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»"è¿æ¥"æŒ‰é’®å¼€å§‹');
        })();
    </script>
</body>
</html>
