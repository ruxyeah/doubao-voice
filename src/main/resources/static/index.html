<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .card h2 {
            color: #333;
            margin-bottom: 16px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #555;
            font-weight: 500;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background: #c0392b;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-success:hover {
            background: #219a52;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 16px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-disconnected { background: #ffeaea; color: #e74c3c; }
        .status-disconnected .status-dot { background: #e74c3c; }
        .status-connected { background: #e8f5e9; color: #27ae60; }
        .status-connected .status-dot { background: #27ae60; }
        .status-session { background: #e3f2fd; color: #2196f3; }
        .status-session .status-dot { background: #2196f3; animation: none; }

        .log-container {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 16px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
        }
        .log-entry {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .log-time {
            color: #888;
            margin-right: 8px;
        }
        .log-info { color: #64b5f6; }
        .log-success { color: #81c784; }
        .log-error { color: #e57373; }
        .log-asr { color: #fff176; }
        .log-chat { color: #ce93d8; }
        .log-tts { color: #4dd0e1; }

        .chat-container {
            height: 200px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: #fafafa;
        }
        .chat-message {
            margin-bottom: 12px;
            padding: 10px 14px;
            border-radius: 12px;
            max-width: 80%;
        }
        .chat-user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .chat-bot {
            background: #e8e8e8;
            color: #333;
        }
        .chat-interim {
            opacity: 0.6;
            font-style: italic;
        }

        .text-input-group {
            display: flex;
            gap: 10px;
        }
        .text-input-group input {
            flex: 1;
        }

        .recording {
            animation: recording-pulse 1s infinite;
        }
        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); }
            50% { box-shadow: 0 0 0 20px rgba(231, 76, 60, 0); }
        }

        /* ç©ºé—²å€’è®¡æ—¶æ ·å¼ */
        .idle-warning {
            display: none;
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            margin-top: 16px;
            text-align: center;
            animation: warning-pulse 1s infinite;
        }
        .idle-warning.show {
            display: block;
        }
        @keyframes warning-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .idle-warning .countdown {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .idle-warning .btn-continue {
            background: white;
            color: #f57c00;
            border: none;
            padding: 10px 30px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .idle-warning .btn-continue:hover {
            background: #fff3e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯æµ‹è¯•</h1>

        <!-- é…ç½®å¡ç‰‡ -->
        <div class="card">
            <h2>ä¼šè¯é…ç½®</h2>
            <div class="form-group">
                <label>éŸ³è‰²</label>
                <select id="speaker">
                    <option value="zh_female_vv_jupiter_bigtts">å¥³å£°-ç”œç¾ï¼ˆé»˜è®¤ï¼‰</option>
                    <option value="zh_male_rap_luna_bigtts">ç”·å£°-è¯´å”±</option>
                    <option value="zh_female_shuangkuaisisi_moon_bigtts">å¥³å£°-çˆ½å¿«æ€æ€</option>
                </select>
            </div>
            <div class="form-group">
                <label>æœºå™¨äººåç§°</label>
                <input type="text" id="botName" value="è±†åŒ…" placeholder="AIåŠ©æ‰‹åç§°">
            </div>
            <div class="form-group">
                <label>ç³»ç»Ÿè§’è‰²è®¾å®š</label>
                <textarea id="systemRole" rows="2" placeholder="ä¾‹å¦‚ï¼šä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„åŠ©æ‰‹ï¼Œå–„äºå›ç­”å„ç§é—®é¢˜"></textarea>
            </div>
            <div class="form-group">
                <label>æ¨¡å‹ç‰ˆæœ¬</label>
                <select id="model">
                    <option value="O">O - åŸºç¡€ç‰ˆæœ¬</option>
                    <option value="SC">SC - å£°éŸ³å¤åˆ»ç‰ˆæœ¬</option>
                    <option value="1.2.1.0">1.2.1.0 - O2.0ç‰ˆæœ¬</option>
                    <option value="2.2.0.0">2.2.0.0 - SC2.0ç‰ˆæœ¬</option>
                </select>
            </div>
        </div>

        <!-- æ§åˆ¶å¡ç‰‡ -->
        <div class="card">
            <h2>è¿æ¥æ§åˆ¶</h2>
            <div id="statusBadge" class="status status-disconnected">
                <span class="status-dot"></span>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
            <div>
                <button id="btnStart" class="btn btn-primary" onclick="startConversation()">ğŸš€ å¼€å§‹å¯¹è¯</button>
                <button id="btnStop" class="btn btn-danger" onclick="stopConversation()" disabled>â¹ï¸ ç»“æŸå¯¹è¯</button>
                <button id="btnReconnect" class="btn btn-success" onclick="manualReconnect()" disabled style="margin-left: 20px;">ğŸ”„ é‡æ–°è¿æ¥</button>
            </div>
            <div id="connectionInfo" style="margin-top: 10px; font-size: 12px; color: #666;"></div>

            <!-- ç©ºé—²å€’è®¡æ—¶è­¦å‘Š -->
            <div id="idleWarning" class="idle-warning">
                <div>âš ï¸ ä¼šè¯å³å°†å› ç©ºé—²è€Œå…³é—­</div>
                <div class="countdown"><span id="countdownSeconds">30</span> ç§’</div>
                <button class="btn-continue" onclick="continueSession()">ç»§ç»­å¯¹è¯</button>
            </div>
        </div>

        <!-- å¯¹è¯å¡ç‰‡ -->
        <div class="card">
            <h2>å¯¹è¯</h2>
            <div id="chatContainer" class="chat-container"></div>

            <div class="text-input-group">
                <input type="text" id="textInput" placeholder="è¾“å…¥æ–‡æœ¬æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')sendText()">
                <button class="btn btn-primary" onclick="sendText()" id="btnSendText" disabled>å‘é€æ–‡æœ¬</button>
            </div>

            <div style="margin-top: 16px;">
                <button id="btnMic" class="btn btn-success" onclick="toggleMic()" disabled>
                    ğŸ¤ å¼€å§‹å½•éŸ³
                </button>
                <span id="micStatus" style="margin-left: 10px; color: #666;"></span>
            </div>
        </div>

        <!-- æ—¥å¿—å¡ç‰‡ -->
        <div class="card">
            <h2>æ—¥å¿—</h2>
            <div id="logContainer" class="log-container"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let ws = null;
        let sessionId = null;
        let audioContext = null;
        let mediaStream = null;
        let processor = null;
        let isRecording = false;
        let audioQueue = [];
        let isPlaying = false;
        let pendingSessionConfig = null; // ç­‰å¾…å¯åŠ¨çš„ä¼šè¯é…ç½®
        let isSessionActive = false; // ä¼šè¯æ˜¯å¦å·²æ¿€æ´»

        // ç©ºé—²æ£€æµ‹ç›¸å…³å˜é‡
        let lastActivityTime = Date.now();
        let idleCheckInterval = null;
        let countdownInterval = null;
        let countdownSeconds = 30;
        const IDLE_WARNING_TIME = 30000;  // 30ç§’åæ˜¾ç¤ºè­¦å‘Š
        const COUNTDOWN_SECONDS = 30;      // å€’è®¡æ—¶30ç§’

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span><span class="log-${type}">${message}</span>`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(status, text) {
            const badge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            badge.className = `status status-${status}`;
            statusText.textContent = text;
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯
        function addChatMessage(text, isUser, isInterim = false) {
            const container = document.getElementById('chatContainer');

            // å¦‚æœæ˜¯ä¸´æ—¶æ¶ˆæ¯ï¼Œå…ˆç§»é™¤ä¹‹å‰çš„ä¸´æ—¶æ¶ˆæ¯
            if (isInterim) {
                const oldInterim = container.querySelector('.chat-interim');
                if (oldInterim) oldInterim.remove();
            }

            const msg = document.createElement('div');
            msg.className = `chat-message ${isUser ? 'chat-user' : 'chat-bot'} ${isInterim ? 'chat-interim' : ''}`;
            msg.textContent = text;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;

            // å¦‚æœæ˜¯æœ€ç»ˆæ¶ˆæ¯ï¼Œç§»é™¤ä¸´æ—¶æ¶ˆæ¯
            if (!isInterim && !isUser) {
                const oldInterim = container.querySelector('.chat-interim');
                if (oldInterim) oldInterim.remove();
            }
        }

        // å¼€å§‹å¯¹è¯ï¼ˆåˆå¹¶è¿æ¥+å¼€å§‹ä¼šè¯ï¼‰
        async function startConversation() {
            try {
                log('æ­£åœ¨å¯åŠ¨å¯¹è¯...', 'info');
                document.getElementById('btnStart').disabled = true;
                updateStatus('connected', 'è¿æ¥ä¸­...');

                // ä¿å­˜ä¼šè¯é…ç½®ï¼Œç­‰è¿æ¥å¯åŠ¨åå†å‘é€
                pendingSessionConfig = {
                    speaker: document.getElementById('speaker').value,
                    botName: document.getElementById('botName').value,
                    systemRole: document.getElementById('systemRole').value,
                    model: document.getElementById('model').value
                };

                // 1. åˆ›å»ºä¼šè¯
                const response = await fetch('/api/v1/voice/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                sessionId = data.sessionId;
                log(`ä¼šè¯å·²åˆ›å»º: ${sessionId}`, 'success');

                // 2. è¿æ¥WebSocket
                const wsUrl = `ws://${window.location.host}/ws/voice?sessionId=${sessionId}`;
                ws = new WebSocket(wsUrl);
                ws.binaryType = 'arraybuffer';

                ws.onopen = () => {
                    log('WebSocketå·²è¿æ¥ï¼Œç­‰å¾…è¿æ¥å¯åŠ¨...', 'success');
                    updateStatus('connected', 'å·²è¿æ¥ï¼Œç­‰å¾…å¯åŠ¨...');
                    // ä¸åœ¨è¿™é‡Œå‘é€å¯åŠ¨ä¼šè¯ï¼Œç­‰å¾…connection_startedäº‹ä»¶
                };

                ws.onmessage = (event) => {
                    if (event.data instanceof ArrayBuffer) {
                        handleAudioData(event.data);
                    } else {
                        const msg = JSON.parse(event.data);
                        handleMessage(msg);
                    }
                };

                ws.onclose = () => {
                    log('WebSocketå·²æ–­å¼€', 'error');
                    updateStatus('disconnected', 'å·²æ–­å¼€');
                    resetUI();
                };

                ws.onerror = (err) => {
                    log('WebSocketé”™è¯¯: ' + err, 'error');
                    resetUI();
                };

            } catch (err) {
                log('å¯åŠ¨å¯¹è¯å¤±è´¥: ' + err, 'error');
                resetUI();
            }
        }

        // ç»“æŸå¯¹è¯ï¼ˆåˆå¹¶ç»“æŸä¼šè¯+æ–­å¼€è¿æ¥ï¼‰
        function stopConversation() {
            log('æ­£åœ¨ç»“æŸå¯¹è¯...', 'info');
            stopRecording();

            if (ws && ws.readyState === WebSocket.OPEN) {
                // å…ˆå‘é€ç»“æŸä¼šè¯
                ws.send(JSON.stringify({
                    type: 'control',
                    action: 'end'
                }));

                // ç¨åæ–­å¼€è¿æ¥
                setTimeout(() => {
                    if (ws) {
                        ws.close();
                        ws = null;
                    }
                }, 500);
            }

            resetUI();
        }

        // æ‰‹åŠ¨é‡æ–°è¿æ¥
        function manualReconnect() {
            log('æ‰‹åŠ¨è§¦å‘é‡æ–°è¿æ¥...', 'info');

            // ä¿å­˜å½“å‰é…ç½®ç”¨äºé‡è¿åæ¢å¤
            pendingSessionConfig = {
                speaker: document.getElementById('speaker').value,
                botName: document.getElementById('botName').value,
                systemRole: document.getElementById('systemRole').value,
                model: document.getElementById('model').value
            };
            isSessionActive = false;

            // å…³é—­ç°æœ‰è¿æ¥
            if (ws) {
                ws.close();
                ws = null;
            }

            // é‡æ–°å¼€å§‹å¯¹è¯
            setTimeout(() => {
                startConversation();
            }, 500);
        }

        // æ›´æ–°è¿æ¥ä¿¡æ¯æ˜¾ç¤º
        function updateConnectionInfo(info) {
            const infoDiv = document.getElementById('connectionInfo');
            if (info) {
                infoDiv.textContent = info;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // å¤„ç†æ¶ˆæ¯
        function handleMessage(msg) {
            switch (msg.type) {
                case 'status':
                    log(`çŠ¶æ€: ${msg.status}`, 'success');
                    if (msg.status === 'connected') {
                        // åˆå§‹è¿æ¥æˆåŠŸï¼Œç­‰å¾…connection_started
                    } else if (msg.status === 'connection_started') {
                        // è¿æ¥å·²å¯åŠ¨ï¼Œç°åœ¨å¯ä»¥å¯åŠ¨ä¼šè¯äº†
                        // åªæœ‰å½“ä¼šè¯æœªæ¿€æ´»ä¸”æœ‰å¾…å¤„ç†çš„é…ç½®æ—¶æ‰å‘é€å¯åŠ¨è¯·æ±‚
                        if (pendingSessionConfig && !isSessionActive) {
                            log('è¿æ¥å·²å¯åŠ¨ï¼Œæ­£åœ¨å¯åŠ¨ä¼šè¯...', 'info');
                            updateStatus('connected', 'æ­£åœ¨å¯åŠ¨ä¼šè¯...');
                            ws.send(JSON.stringify({
                                type: 'control',
                                action: 'start',
                                config: pendingSessionConfig
                            }));
                            pendingSessionConfig = null;
                        }
                    } else if (msg.status === 'session_started') {
                        isSessionActive = true;
                        updateStatus('session', 'å¯¹è¯ä¸­');
                        updateConnectionInfo('ä¼šè¯å·²å¯åŠ¨ï¼Œå¯ä»¥å¼€å§‹å¯¹è¯');
                        document.getElementById('btnStart').disabled = true;
                        document.getElementById('btnStop').disabled = false;
                        document.getElementById('btnReconnect').disabled = false;
                        document.getElementById('btnMic').disabled = false;
                        document.getElementById('btnSendText').disabled = false;
                        // å¯åŠ¨ç©ºé—²æ£€æµ‹
                        startIdleCheck();
                    } else if (msg.status === 'session_finished') {
                        isSessionActive = false;
                        updateStatus('disconnected', 'å·²ç»“æŸ');
                        resetUI();
                    } else if (msg.status === 'reconnecting') {
                        log(`æ­£åœ¨é‡è¿ (${msg.attempt}/${msg.maxAttempts})ï¼Œ${msg.delayMs/1000}ç§’åé‡è¯•...`, 'info');
                        updateStatus('disconnected', `é‡è¿ä¸­ ${msg.attempt}/${msg.maxAttempts}`);
                        updateConnectionInfo(`æ­£åœ¨å°è¯•ç¬¬${msg.attempt}æ¬¡é‡è¿ï¼Œè¯·ç¨å€™...`);
                        isSessionActive = false; // é‡è¿ä¸­ä¼šè¯å¤±æ•ˆ
                    } else if (msg.status === 'reconnected') {
                        log(`é‡è¿æˆåŠŸï¼Œå…±å°è¯•${msg.attempts}æ¬¡ï¼Œç­‰å¾…ä¼šè¯è‡ªåŠ¨æ¢å¤...`, 'success');
                        updateStatus('connected', 'å·²é‡è¿ï¼Œæ¢å¤ä¼šè¯ä¸­...');
                        updateConnectionInfo('é‡è¿æˆåŠŸï¼Œæ­£åœ¨è‡ªåŠ¨æ¢å¤ä¼šè¯...');
                        // ä¼šè¯å°†ç”±åç«¯è‡ªåŠ¨é‡å¯ï¼Œç­‰å¾…session_startedäº‹ä»¶
                    }
                    break;

                case 'asr':
                    resetActivity(); // é‡ç½®ç©ºé—²è®¡æ—¶
                    if (msg.event === 'result') {
                        log(`ASR: ${msg.text} ${msg.isInterim ? '(ä¸´æ—¶)' : '(æœ€ç»ˆ)'}`, 'asr');
                        if (!msg.isInterim) {
                            addChatMessage(msg.text, true);
                        }
                    } else if (msg.event === 'speech_started') {
                        log('æ£€æµ‹åˆ°ç”¨æˆ·è¯´è¯', 'asr');
                        // æ¸…ç©ºéŸ³é¢‘é˜Ÿåˆ—ï¼Œåœæ­¢æ’­æ”¾
                        audioQueue = [];
                    }
                    break;

                case 'chat':
                    resetActivity(); // é‡ç½®ç©ºé—²è®¡æ—¶
                    if (msg.event === 'response') {
                        log(`AI: ${msg.text}`, 'chat');
                        addChatMessage(msg.text, false);
                    }
                    break;

                case 'tts':
                    resetActivity(); // é‡ç½®ç©ºé—²è®¡æ—¶
                    if (msg.event === 'sentence_start') {
                        log(`TTSå¼€å§‹: ${msg.text}`, 'tts');
                    } else if (msg.event === 'ended') {
                        log('TTSæ’­æ”¾ç»“æŸ', 'tts');
                    }
                    break;

                case 'error':
                    log(`é”™è¯¯: ${msg.error}`, 'error');
                    break;

                case 'warning':
                    if (msg.warning === 'connection_timeout') {
                        log(`âš ï¸ è¿æ¥è¶…æ—¶: ç­‰å¾…${msg.pendingRequests}ä¸ªå“åº”ï¼Œç©ºé—²${Math.round(msg.lastReceiveAgo/1000)}ç§’`, 'error');
                        updateStatus('disconnected', 'è¿æ¥è¶…æ—¶ï¼Œæ­£åœ¨é‡è¿...');
                        updateConnectionInfo(`è¿æ¥ç©ºé—²è¶…æ—¶ï¼Œç³»ç»Ÿæ­£åœ¨è‡ªåŠ¨é‡è¿...`);
                    }
                    break;
            }
        }

        // å¤„ç†éŸ³é¢‘æ•°æ®
        function handleAudioData(data) {
            audioQueue.push(data);
            if (!isPlaying) {
                playNextAudio();
            }
        }

        // æ’­æ”¾éŸ³é¢‘é˜Ÿåˆ—
        async function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            isPlaying = true;
            const data = audioQueue.shift();

            try {
                if (!audioContext) {
                    audioContext = new AudioContext({ sampleRate: 24000 });
                }

                // æ•°æ®æ˜¯Float32æ ¼å¼
                const float32Array = new Float32Array(data);
                const audioBuffer = audioContext.createBuffer(1, float32Array.length, 24000);
                audioBuffer.getChannelData(0).set(float32Array);

                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.onended = () => playNextAudio();
                source.start();
            } catch (e) {
                log('æ’­æ”¾éŸ³é¢‘å¤±è´¥: ' + e.message, 'error');
                playNextAudio();
            }
        }

        // é‡ç½®UI
        function resetUI() {
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('btnReconnect').disabled = true;
            document.getElementById('btnMic').disabled = true;
            document.getElementById('btnSendText').disabled = true;
            updateStatus('disconnected', 'æœªè¿æ¥');
            updateConnectionInfo('');
            pendingSessionConfig = null;
            isSessionActive = false;
            // åœæ­¢ç©ºé—²æ£€æµ‹
            stopIdleCheck();
        }

        // å‘é€æ–‡æœ¬
        function sendText() {
            const input = document.getElementById('textInput');
            const text = input.value.trim();
            if (!text) return;

            // æ£€æŸ¥è¿æ¥çŠ¶æ€
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âš ï¸ è¿æ¥å·²æ–­å¼€ï¼Œè¯·é‡æ–°å¼€å§‹å¯¹è¯', 'error');
                return;
            }

            // é‡ç½®ç©ºé—²è®¡æ—¶
            resetActivity();

            log(`å‘é€æ–‡æœ¬: ${text}`, 'info');
            addChatMessage(text, true);

            ws.send(JSON.stringify({
                type: 'text',
                text: text
            }));

            input.value = '';
        }

        // åˆ‡æ¢éº¦å…‹é£
        function toggleMic() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                // å…¼å®¹æ€§æ£€æŸ¥
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    // å°è¯•ä½¿ç”¨æ—§ç‰ˆAPI
                    navigator.mediaDevices = navigator.mediaDevices || {};
                    navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia ||
                        navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia ||
                        navigator.msGetUserMedia;

                    if (!navigator.mediaDevices.getUserMedia) {
                        throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£è®¿é—®ã€‚è¯·ä½¿ç”¨ Chromeã€Firefox æˆ– Edge æµè§ˆå™¨ï¼Œå¹¶ç¡®ä¿é€šè¿‡ HTTPS æˆ– localhost è®¿é—®ã€‚');
                    }
                }

                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 48000,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                const context = new AudioContext({ sampleRate: 48000 });
                const source = context.createMediaStreamSource(mediaStream);
                processor = context.createScriptProcessor(4096, 1, 1);

                processor.onaudioprocess = (e) => {
                    if (!isRecording) return;

                    const inputData = e.inputBuffer.getChannelData(0);
                    // é‡é‡‡æ · 48kHz -> 16kHz
                    const resampledData = resample(inputData, 48000, 16000);
                    // è½¬æ¢ä¸ºPCM16
                    const pcmData = convertToPCM16(resampledData);

                    // å‘é€éŸ³é¢‘æ•°æ®
                    ws.send(JSON.stringify({
                        type: 'audio',
                        data: arrayBufferToBase64(pcmData.buffer)
                    }));
                };

                source.connect(processor);
                processor.connect(context.destination);

                isRecording = true;
                resetActivity(); // é‡ç½®ç©ºé—²è®¡æ—¶
                document.getElementById('btnMic').textContent = 'ğŸ”´ åœæ­¢å½•éŸ³';
                document.getElementById('btnMic').classList.add('recording');
                document.getElementById('micStatus').textContent = 'æ­£åœ¨å½•éŸ³...';
                log('å¼€å§‹å½•éŸ³', 'success');

            } catch (e) {
                log('æ— æ³•è®¿é—®éº¦å…‹é£: ' + e.message, 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        function stopRecording() {
            isRecording = false;
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (processor) {
                processor.disconnect();
                processor = null;
            }
            document.getElementById('btnMic').textContent = 'ğŸ¤ å¼€å§‹å½•éŸ³';
            document.getElementById('btnMic').classList.remove('recording');
            document.getElementById('micStatus').textContent = '';
            log('åœæ­¢å½•éŸ³', 'info');
        }

        // é‡é‡‡æ ·
        function resample(inputData, fromRate, toRate) {
            const ratio = fromRate / toRate;
            const newLength = Math.round(inputData.length / ratio);
            const result = new Float32Array(newLength);

            for (let i = 0; i < newLength; i++) {
                const srcIndex = i * ratio;
                const srcIndexFloor = Math.floor(srcIndex);
                const srcIndexCeil = Math.min(srcIndexFloor + 1, inputData.length - 1);
                const t = srcIndex - srcIndexFloor;
                result[i] = inputData[srcIndexFloor] * (1 - t) + inputData[srcIndexCeil] * t;
            }
            return result;
        }

        // è½¬æ¢ä¸ºPCM16
        function convertToPCM16(float32Array) {
            const int16Array = new Int16Array(float32Array.length);
            for (let i = 0; i < float32Array.length; i++) {
                const sample = Math.max(-1, Math.min(1, float32Array[i]));
                int16Array[i] = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
            }
            return new Uint8Array(int16Array.buffer);
        }

        // ArrayBufferè½¬Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        // ==================== ç©ºé—²æ£€æµ‹å’Œå€’è®¡æ—¶åŠŸèƒ½ ====================

        // å¼€å§‹ç©ºé—²æ£€æµ‹
        function startIdleCheck() {
            stopIdleCheck(); // å…ˆåœæ­¢ä¹‹å‰çš„æ£€æµ‹
            lastActivityTime = Date.now();

            idleCheckInterval = setInterval(() => {
                if (!isSessionActive) {
                    stopIdleCheck();
                    return;
                }

                const idleTime = Date.now() - lastActivityTime;

                // å¦‚æœç©ºé—²æ—¶é—´è¶…è¿‡è­¦å‘Šæ—¶é—´ï¼Œæ˜¾ç¤ºå€’è®¡æ—¶
                if (idleTime >= IDLE_WARNING_TIME && !countdownInterval) {
                    startCountdown();
                }
            }, 1000);

            log('ç©ºé—²æ£€æµ‹å·²å¯åŠ¨', 'info');
        }

        // åœæ­¢ç©ºé—²æ£€æµ‹
        function stopIdleCheck() {
            if (idleCheckInterval) {
                clearInterval(idleCheckInterval);
                idleCheckInterval = null;
            }
            stopCountdown();
        }

        // é‡ç½®æ´»åŠ¨æ—¶é—´ï¼ˆç”¨æˆ·æœ‰æ´»åŠ¨æ—¶è°ƒç”¨ï¼‰
        function resetActivity() {
            lastActivityTime = Date.now();
            // å¦‚æœæ­£åœ¨æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œéšè—å®ƒ
            if (countdownInterval) {
                stopCountdown();
                log('ç”¨æˆ·æ´»åŠ¨ï¼Œå€’è®¡æ—¶å·²å–æ¶ˆ', 'info');
            }
        }

        // å¼€å§‹å€’è®¡æ—¶
        function startCountdown() {
            countdownSeconds = COUNTDOWN_SECONDS;
            const warningDiv = document.getElementById('idleWarning');
            const countdownSpan = document.getElementById('countdownSeconds');

            warningDiv.classList.add('show');
            countdownSpan.textContent = countdownSeconds;

            log(`âš ï¸ ä¼šè¯ç©ºé—²ï¼Œ${COUNTDOWN_SECONDS}ç§’åå°†è‡ªåŠ¨å…³é—­`, 'error');

            countdownInterval = setInterval(() => {
                countdownSeconds--;
                countdownSpan.textContent = countdownSeconds;

                if (countdownSeconds <= 0) {
                    // å€’è®¡æ—¶ç»“æŸï¼Œå…³é—­ä¼šè¯
                    stopCountdown();
                    log('ä¼šè¯å› ç©ºé—²è¶…æ—¶è€Œå…³é—­', 'error');
                    stopConversation();
                }
            }, 1000);
        }

        // åœæ­¢å€’è®¡æ—¶
        function stopCountdown() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            const warningDiv = document.getElementById('idleWarning');
            warningDiv.classList.remove('show');
            countdownSeconds = COUNTDOWN_SECONDS;
        }

        // ç”¨æˆ·ç‚¹å‡»ç»§ç»­å¯¹è¯
        function continueSession() {
            resetActivity();
            log('ç”¨æˆ·é€‰æ‹©ç»§ç»­å¯¹è¯', 'success');

            // å‘é€ä¸€ä¸ªå¿ƒè·³/pingæ¶ˆæ¯ä¿æŒä¼šè¯æ´»è·ƒï¼ˆå¯é€‰ï¼‰
            // è¿™é‡Œåªæ˜¯é‡ç½®æœ¬åœ°è®¡æ—¶å™¨ï¼ŒæœåŠ¡ç«¯çš„recv_timeoutä¹Ÿä¼šå› ä¸ºæœ‰æ•°æ®äº¤äº’è€Œé‡ç½®
        }

        // é¡µé¢åˆå§‹åŒ– - æ£€æŸ¥å®‰å…¨ä¸Šä¸‹æ–‡
        (function init() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå®‰å…¨ä¸Šä¸‹æ–‡
            const isSecureContext = window.isSecureContext ||
                location.protocol === 'https:' ||
                location.hostname === 'localhost' ||
                location.hostname === '127.0.0.1';

            if (!isSecureContext) {
                log('è­¦å‘Š: å½“å‰é¡µé¢ä¸åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼Œéº¦å…‹é£åŠŸèƒ½å¯èƒ½æ— æ³•ä½¿ç”¨ã€‚è¯·é€šè¿‡ https:// æˆ– localhost è®¿é—®ã€‚', 'error');
            }

            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (!navigator.mediaDevices && !navigator.getUserMedia) {
                log('è­¦å‘Š: æ‚¨çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒéº¦å…‹é£è®¿é—®ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Firefox æˆ– Edgeã€‚', 'error');
            }

            log('é¡µé¢åŠ è½½å®Œæˆï¼Œç‚¹å‡»"å¼€å§‹å¯¹è¯"æŒ‰é’®å¼€å§‹');
        })();
    </script>
</body>
</html>
